---
/**
 * Language Selector Component
 * Seletor de idioma com √≠cone de planeta e dropdown para PT-BR, EN, ES
 */

import { getLangFromUrl, getLocalizedUrl } from '@/i18n/utils';
import { languages, type Language } from '@/i18n/config';
import { useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// URLs para cada idioma
const getLanguageUrl = (targetLang: Language) => {
  // Remove prefixo de idioma atual se existir (en ou es)
  let currentPath = Astro.url.pathname;

  // Remove prefixo de idioma se existir
  if (currentPath.startsWith('/en/') || currentPath.startsWith('/es/')) {
    currentPath = currentPath.replace(/^\/(en|es)/, '');
  }

  // Se estiver na raiz ap√≥s remover prefixo, garante que √© '/'
  if (currentPath === '' || currentPath === '/') {
    currentPath = '/';
  } else if (!currentPath.startsWith('/')) {
    // Garante que come√ßa com /
    currentPath = `/${currentPath}`;
  }

  return getLocalizedUrl(currentPath, targetLang);
};
---

<div class="language-selector" data-language-selector>
  <button
    class="language-selector__trigger"
    aria-label={t('nav.openLanguageMenu')}
    aria-expanded="false"
    aria-haspopup="true"
    id="language-selector-trigger"
  >
    <span class="language-selector__icon" aria-hidden="true">üåê</span>
    <span
      class="language-selector__current"
      aria-label={t('nav.currentLanguage')}
    >
      {lang === 'pt-BR' ? 'PT' : lang.toUpperCase()}
    </span>
    <svg
      class="language-selector__chevron"
      width="12"
      height="12"
      viewBox="0 0 12 12"
      fill="none"
      aria-hidden="true"
    >
      <path
        d="M3 4.5L6 7.5L9 4.5"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"></path>
    </svg>
  </button>

  <ul
    class="language-selector__dropdown"
    role="menu"
    aria-labelledby="language-selector-trigger"
    aria-hidden="true"
    id="language-selector-dropdown"
  >
    {
      Object.entries(languages).map(([langCode, langName]) => {
        const isActive = lang === langCode;
        const langUrl = getLanguageUrl(langCode as Language);

        return (
          <li role="none">
            <a
              href={langUrl}
              hreflang={langCode}
              class:list={[
                'language-selector__option',
                { 'language-selector__option--active': isActive },
              ]}
              role="menuitem"
              aria-current={isActive ? 'page' : undefined}
            >
              <span class="language-selector__option-code">
                {langCode === 'pt-BR' ? 'PT' : langCode.toUpperCase()}
              </span>
              <span class="language-selector__option-name">{langName}</span>
              {isActive && (
                <svg
                  class="language-selector__check"
                  width="16"
                  height="16"
                  viewBox="0 0 16 16"
                  fill="none"
                  aria-hidden="true"
                >
                  <path
                    d="M13.3333 4L6 11.3333L2.66667 8"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              )}
            </a>
          </li>
        );
      })
    }
  </ul>
</div>

<script>
  const languageSelector = document.querySelector('[data-language-selector]');
  const trigger = document.getElementById('language-selector-trigger');
  const dropdown = document.getElementById('language-selector-dropdown');

  if (trigger && dropdown) {
    // Toggle dropdown
    trigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

      if (isExpanded) {
        closeLanguageMenu();
      } else {
        openLanguageMenu();
      }
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (languageSelector && !languageSelector.contains(e.target as Node)) {
        closeLanguageMenu();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (
        e.key === 'Escape' &&
        trigger.getAttribute('aria-expanded') === 'true'
      ) {
        closeLanguageMenu();
        trigger.focus();
      }
    });

    function openLanguageMenu() {
      trigger?.setAttribute('aria-expanded', 'true');
      dropdown?.setAttribute('aria-hidden', 'false');
      languageSelector?.classList.add('language-selector--open');
    }

    function closeLanguageMenu() {
      trigger?.setAttribute('aria-expanded', 'false');
      dropdown?.setAttribute('aria-hidden', 'true');
      languageSelector?.classList.remove('language-selector--open');
    }
  }
</script>

<style>
  .language-selector {
    position: relative;
  }

  .language-selector__trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: #ffffff;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .language-selector__trigger:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .language-selector__trigger:focus-visible {
    outline: 2px solid #ffffff;
    outline-offset: 2px;
  }

  .language-selector__icon {
    font-size: 1.125rem;
    line-height: 1;
  }

  .language-selector__current {
    font-weight: 600;
  }

  .language-selector__chevron {
    transition: transform 0.2s ease;
  }

  .language-selector--open .language-selector__chevron {
    transform: rotate(180deg);
  }

  .language-selector__dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 160px;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 0.5rem;
    list-style: none;
    margin: 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .language-selector--open .language-selector__dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-selector__option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    color: #ffffff;
    text-decoration: none;
    border-radius: 0.375rem;
    transition: background-color 0.15s ease;
    font-size: 0.875rem;
  }

  .language-selector__option:hover,
  .language-selector__option:focus-visible {
    background: rgba(255, 255, 255, 0.1);
    outline: none;
  }

  .language-selector__option--active {
    background: rgba(255, 255, 255, 0.15);
    font-weight: 600;
  }

  .language-selector__option-code {
    font-weight: 600;
    min-width: 32px;
  }

  .language-selector__option-name {
    flex: 1;
  }

  .language-selector__check {
    margin-left: auto;
    color: #ffffff;
  }

  /* Mobile adjustments */
  @media (max-width: 767px) {
    .language-selector__trigger {
      padding: 0.5rem;
      gap: 0.375rem;
      min-height: 40px;
    }

    .language-selector__current {
      display: none;
    }

    .language-selector__dropdown {
      right: 0;
      min-width: 140px;
    }
  }

  /* Mobile pequeno */
  @media (max-width: 374px) {
    .language-selector__trigger {
      padding: 0.375rem;
      min-height: 36px;
    }

    .language-selector__icon {
      font-size: 1rem;
    }
  }
</style>
