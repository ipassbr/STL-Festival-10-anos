---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

interface Props {
  videoUrl?: string;
  fallbackImage?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// URLs de mídia (mesmas do HeroSection)
const {
  videoUrl = import.meta.env.PUBLIC_CLOUDINARY_VIDEO_URL ||
    'https://res.cloudinary.com/dazkdemvu/video/upload/v1768415565/stl-festival/videos/hero.mp4',
  fallbackImage = import.meta.env.PUBLIC_FALLBACK_IMAGE_URL ||
    '/assets/images/fallbacks/herosection.jpg',
} = Astro.props;
---

<div
  id="preloader"
  class="preloader"
  role="status"
  aria-label={t('preloader.ariaLabel')}
  data-video-url={videoUrl}
  data-image-url={fallbackImage}
>
  <div class="preloader__content">
    <p
      id="preloader-text"
      class="preloader__text"
      aria-live="polite"
      aria-atomic="true"
    >
      {t('preloader.text')}
    </p>
  </div>
  <div class="preloader__progress-track" aria-hidden="true">
    <div id="preloader-progress-bar" class="preloader__progress-bar"></div>
  </div>
</div>

<script>
  import { PreloaderManager } from '../scripts/preloader/preloaderManager';

  const preloaderEl = document.getElementById('preloader');
  const textEl = document.getElementById('preloader-text');
  const progressBarEl = document.getElementById('preloader-progress-bar');

  if (!preloaderEl || !textEl || !progressBarEl) {
    console.error('Preloader elements not found');
  } else {
    // Texto completo para animação progressiva
    const fullText = textEl.textContent || '';
    const words = fullText.split(' ');

    // Verifica preferência de reduced motion
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    /**
     * Atualiza texto progressivamente baseado no progresso
     */
    function updateTextProgress(progress: number): void {
      if (prefersReducedMotion) {
        // Se reduced motion, mostra texto completo quando progresso > 50%
        if (progress >= 50 && textEl.textContent !== fullText) {
          textEl.textContent = fullText;
          textEl.classList.add('visible');
        }
        return;
      }

      // Calcula quantas palavras devem estar visíveis
      const visibleWords = Math.floor((progress / 100) * words.length);
      const visibleText = words.slice(0, visibleWords).join(' ');

      if (visibleText && textEl.textContent !== visibleText) {
        textEl.textContent = visibleText;
        if (visibleWords > 0) {
          textEl.classList.add('visible');
        }
      }
    }

    /**
     * Atualiza barra de progresso
     */
    function updateProgressBar(progress: number): void {
      progressBarEl.style.width = `${progress}%`;
    }

    // Tempo mínimo de exibição do preloader (2.5 segundos)
    // Garante que o usuário tenha tempo suficiente para ver e sentir o preloader
    const minDisplayTime = 2500;
    const startTime = Date.now();

    /**
     * Manipula progresso do preload com delay mínimo para melhor experiência
     */
    function handleProgress(progress: number): void {
      // Limita progresso a 90% até completar (garante tempo mínimo de visualização)
      // Isso faz com que o preloader pare um pouco antes de completar, dando mais tempo ao usuário
      const adjustedProgress = Math.min(progress, 90);
      updateProgressBar(adjustedProgress);
      updateTextProgress(adjustedProgress);
    }

    /**
     * Manipula conclusão do preload com tempo mínimo de exibição
     */
    function handleComplete(): void {
      const elapsed = Date.now() - startTime;
      const remainingTime = Math.max(0, minDisplayTime - elapsed);

      // Aguarda tempo mínimo antes de completar (garante que usuário veja o preloader)
      setTimeout(() => {
        // Garante que texto e barra estão em 100%
        updateProgressBar(100);
        updateTextProgress(100);
        textEl.textContent = fullText;
        textEl.classList.add('visible');

        // Fade out do preloader (mais lento para melhor experiência)
        setTimeout(() => {
          preloaderEl.classList.add('preloader--hidden');

          // Remove do DOM após animação
          setTimeout(() => {
            preloaderEl.remove();
          }, 800); // Aumentado de 500ms para 800ms
        }, 500); // Aumentado de 300ms para 500ms
      }, remainingTime);
    }

    // Escuta eventos do preloader
    window.addEventListener('preloader-progress', ((e: CustomEvent<number>) => {
      handleProgress(e.detail);
    }) as EventListener);

    window.addEventListener('preloader-complete', () => {
      handleComplete();
    });

    // URLs de mídia (passadas via data attributes)
    const videoUrl = preloaderEl.dataset.videoUrl || '';
    const imageUrl = preloaderEl.dataset.imageUrl || '';

    // Inicia preloader
    const manager = new PreloaderManager({
      heroVideoSrc: videoUrl || undefined,
      heroImageSrc: imageUrl || undefined,
      fonts: ['16px Jairo', '16px "Superbusy Activity"'],
      onProgress: handleProgress,
      onComplete: handleComplete,
    });

    manager.start().catch((error) => {
      console.error('Preloader error:', error);
      // Força conclusão em caso de erro após 2 segundos
      setTimeout(() => {
        handleComplete();
      }, 2000);
    });
  }
</script>

<style>
  .preloader {
    position: fixed;
    inset: 0;
    background: #000000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transition: opacity 500ms ease-out;
  }

  .preloader--hidden {
    opacity: 0;
    pointer-events: none;
  }

  .preloader__content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    margin-bottom: 4rem;
  }

  .preloader__text {
    color: #ffffff;
    font-family:
      var(--font-heading, 'Jairo'),
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
    font-weight: normal;
    font-size: clamp(1rem, 4vw, 1.5rem);
    text-align: center;
    opacity: 0;
    transition: opacity 400ms ease; /* Aumentado de 300ms para 400ms */
    line-height: 1.6;
    max-width: 90%;
    letter-spacing: 0.02em;
  }

  .preloader__text.visible {
    opacity: 1;
  }

  .preloader__progress-track {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: rgba(255, 255, 255, 0.1);
    z-index: 10000;
  }

  .preloader__progress-bar {
    height: 100%;
    width: 0%;
    background: #ffffff;
    transition: width 500ms ease-out; /* Aumentado de 300ms para 500ms para movimento mais suave */
    will-change: width;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .preloader__text,
    .preloader__progress-bar {
      transition: none;
    }
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .preloader__text {
      font-size: clamp(0.875rem, 3.5vw, 1.25rem);
      padding: 0 1rem;
    }

    .preloader__content {
      margin-bottom: 3rem;
    }
  }
</style>
