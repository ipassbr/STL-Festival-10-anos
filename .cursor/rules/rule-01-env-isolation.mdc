================================================================================
rule-01-env-isolation.md
LEI 01: Isolamento de Ambientes
================================================================================

MOTIVO:
Prevenir vazamento de credenciais de APIs (Cloudinary, Analytics) para o
browser e evitar que secrets de producao sejam exposts ou hardcoded no
codigo fonte. Projeto frontend-only (Astro) sem backend ou banco de dados.

GATILHO:
Ativado ao configurar variaveis de ambiente, credenciais de APIs externas
ou configs de deploy (Vercel, Cloudinary, Analytics).

SEGREGACAO OBRIGATORIA:
- PUBLIC_ vs Server-Only: O Astro/Vite expoe NO BROWSER apenas variaveis
  com prefixo PUBLIC_. Variaveis sem esse prefixo existem apenas no
  build-time ou em contexto server-side (frontmatter .astro, API routes).
  NUNCA adicione PUBLIC_ a credenciais secretas.
- Arquivos .env Separados: Use .env.development e .env.production para
  segregar valores entre ambientes. O Vite carrega automaticamente o arquivo
  correspondente ao NODE_ENV.
- Feature Flags: Codigo nao finalizado deve estar atras de feature flags,
  nunca commitado diretamente em main/master.

PROIBICOES:
- Hardcode de URLs de producao em codigo fonte (use SITE via import.meta.env)
- Adicionar PUBLIC_ a CLOUDINARY_API_KEY ou CLOUDINARY_API_SECRET
- Usar credenciais secretas em componentes React client-side (client:*)
- Commitar .env ou .env.production com valores reais
- Expor tokens ou chaves de API em atributos HTML ou console.log

CLASSIFICACAO DE VARIAVEIS DO PROJETO:

| Variavel                       | Prefixo   | Motivo                                     |
|--------------------------------|-----------|--------------------------------------------|
| PUBLIC_CLOUDINARY_CLOUD_NAME   | PUBLIC_   | Identificador publico, seguro no browser   |
| PUBLIC_GA_ID                   | PUBLIC_   | ID de Analytics, seguro no browser         |
| SITE                           | (nenhum)  | URL do site, usado no build-time           |
| CLOUDINARY_API_KEY             | (nenhum)  | Credencial secreta, server-only            |
| CLOUDINARY_API_SECRET          | (nenhum)  | Credencial secreta, NUNCA no browser       |

ARQUIVOS DE ENV SEPARADOS:
```bash
# .env.example (SEMPRE commitado como template)
SITE=https://stlfestival.com.br
PUBLIC_CLOUDINARY_CLOUD_NAME=stl-festival
PUBLIC_GA_ID=G-XXXXXXXXXX
CLOUDINARY_API_KEY=your_api_key_here
CLOUDINARY_API_SECRET=your_api_secret_here

# .env.development (gitignore, valores de teste)
SITE=http://localhost:4321
PUBLIC_CLOUDINARY_CLOUD_NAME=stl-festival
PUBLIC_GA_ID=G-XXXXXXXXXX
CLOUDINARY_API_KEY=dev_key_xxxxx
CLOUDINARY_API_SECRET=dev_secret_xxxxx

# .env.production (NUNCA commitado, valores reais)
SITE=https://stlfestival.com.br
PUBLIC_CLOUDINARY_CLOUD_NAME=stl-festival
PUBLIC_GA_ID=G-XXXXXXXXXX
CLOUDINARY_API_KEY=live_key_xxxxx
CLOUDINARY_API_SECRET=live_secret_xxxxx
```

VALIDACAO NO CODIGO:
```typescript
// src/utils/env.ts
// Valida que credenciais secretas nao vazam para o client-side

export function validateEnv(): void {
  // Variavel publica — segura no browser
  const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME
  if (!cloudName) {
    throw new Error("PUBLIC_CLOUDINARY_CLOUD_NAME nao definida!")
  }

  // Variavel secreta — deve existir apenas no contexto server
  // Se esta linha executar no browser, algo esta errado
  if (typeof window !== "undefined") {
    if (import.meta.env.CLOUDINARY_API_SECRET) {
      throw new Error("CREDENCIAL SECRETA EXPOSTA NO BROWSER!")
    }
  }
}
```

UPLOAD CLOUDINARY — REGRAS DE USO:
```typescript
// ✅ CORRETO: Upload via componente .astro (server-side frontmatter)
// src/pages/upload.astro
---
import { v2 as cloudinary } from "cloudinary"

// Credenciais acessiveis apenas no server
cloudinary.config({
  cloud_name: import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME,
  api_key: import.meta.env.CLOUDINARY_API_KEY,
  api_secret: import.meta.env.CLOUDINARY_API_SECRET,
})

const result = await cloudinary.uploader.upload(imagePath)
---

// ✅ CORRETO: Upload via API Route do Astro
// src/pages/api/upload.ts
import type { APIRoute } from "astro"
import { v2 as cloudinary } from "cloudinary"

export const POST: APIRoute = async ({ request }) => {
  cloudinary.config({
    cloud_name: import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME,
    api_key: import.meta.env.CLOUDINARY_API_KEY,        // server-only
    api_secret: import.meta.env.CLOUDINARY_API_SECRET,  // server-only
  })
  // ... logica de upload
}

// ❌ ERRADO: Usar credenciais secretas em componente React client
// src/components/UploadButton.tsx (com client:load)
// NUNCA faz isso:
//   const secret = import.meta.env.CLOUDINARY_API_SECRET  // undefined no browser!
//   cloudinary.config({ api_secret: secret })             // quebrado e inseguro

// ✅ CORRETO: Componente React chama a API route
// src/components/UploadButton.tsx
export default function UploadButton() {
  const handleUpload = async (file: File) => {
    const formData = new FormData()
    formData.append("file", file)

    // Chama a API route que tem acesso aos secrets
    const response = await fetch("/api/upload", {
      method: "POST",
      body: formData,
    })
    return response.json()
  }
  // ...
}
```

CHECKLIST PRE-DEPLOY:
- [ ] .env.production NÃO está no git (verificar .gitignore)
- [ ] .env.example está atualizado com todas as variaveis necessarias
- [ ] Nenhuma credencial secreta tem prefixo PUBLIC_
- [ ] Credenciais secretas são usadas apenas em frontmatter .astro ou API routes
- [ ] Componentes React client-side não acessam import.meta.env sem PUBLIC_
- [ ] Vercel configurado com variaveis de ambiente no painel (não no código)
