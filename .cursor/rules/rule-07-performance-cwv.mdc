---
alwaysApply: true
---

================================================================================
rule-07-performance-cwv.md
LEI 07: Performance & Core Web Vitals
================================================================================

MOTIVO:
Os KPIs do projeto exigem LCP <2.5s, FID <100ms, CLS <0.1 e Lighthouse 90+.
Esses targets n√£o acontecem por acidente ‚Äî requerem decis√µes t√©cnicas deliberadas
em cada componente, imagem e recurso externo.

GATILHO:
Ativado ao adicionar imagens, fontes customizadas, scripts externos,
componentes React, ou qualquer recurso que impacta o carregamento da page.

TARGETS OBRIGAT√ìRIOS:
| M√©trica | Target | Prioridade |
|---------|--------|-----------|
| Lighthouse Score | ‚â• 90 | üî¥ Bloqueador de PR |
| LCP (Largest Contentful Paint) | < 2.5s | üî¥ Bloqueador |
| FID / INP (Interaction to Next Paint) | < 100ms | üî¥ Bloqueador |
| CLS (Cumulative Layout Shift) | < 0.1 | üî¥ Bloqueador |
| Total JS Bundle | < 50KB gzipped | üü° Warning |
| Total Page Weight | < 200KB (sem imagens) | üü° Warning |

REGRAS DE IMAGENS:
1. Todas as imagens DEVEM usar Cloudinary com transforma√ß√µes autom√°ticas
2. Imagens no hero (above-the-fold): `loading="eager"` + `fetchpriority="high"`
3. Imagens abaixo do fold: `loading="lazy"` obrigat√≥rio
4. Formato: sempre usar `auto:format` (entrega WebP/AVIF automaticamente)
5. Qualidade: usar `quality:auto` (otimiza por contexto)
6. Responsividade: usar `srcset` com pelo menos 3 larguras (320, 768, 1200px)
7. Dimens√µes expl√≠citas obrigat√≥rias (previne CLS)

REGRAS DE FONTES:
1. Custom fonts (Jairo, Superbusy Activity): carregar via `<link rel="preconnect">` + `<link rel="preload">`
2. Usar `font-display: swap` para evitar FOIT (Flash of Invisible Text)
3. Sistema fonts para body text (sem carregamento externo)
4. Limitar custom fonts a headings apenas ‚Äî body usa system font stack

REGRAS DE CSS:
1. Tailwind com `content` configurado (purge autom√°tico no build)
2. Nenhum CSS unused no bundle final
3. Critical CSS inline no `<head>` (Astro faz isso automaticamente)
4. Sem imports de CSS que n√£o sejam usados no componente

REGRAS DE SCRIPTS:
1. Scripts externos (Analytics): carregar com `defer` ou `async`
2. Google Analytics: carregar ap√≥s o LCP via script tag com `async`
3. Nenhum script bloqueia o render
4. Framer Motion: importar apenas os componentes usados (tree-shaking)

PROIBI√á√ïES:
- Imagens sem dimens√µes expl√≠citas (causa CLS)
- Imagens sem Cloudinary em produ√ß√£o (sem otimiza√ß√£o)
- Fontes custom no body text
- Scripts render-blocking no `<head>` sem defer/async
- Import completo de libraries quando apenas um componente √© usado
- Lighthouse score abaixo de 90 mergeable para main

EXEMPLO ERRADO:
```astro
{/* ‚ùå ERRADO: Imagem sem otimiza√ß√£o, sem dimens√µes, sem lazy loading */}
<img src="/images/artist-photo.jpg" alt="Edson Gomes" />

{/* ‚ùå ERRADO: Fonte custom no body */}
<style>
  body { font-family: 'Jairo', serif; }
</style>

{/* ‚ùå ERRADO: Script render-blocking */}
<script src="https://www.google-analytics.com/analytics.js"></script>

{/* ‚ùå ERRADO: Import completo do Framer Motion */}
import { motion, AnimatePresence, LazyMotion, m, features } from 'framer-motion'
```

EXEMPLO CORRETO:
```astro
{/* ‚úÖ CORRETO: Imagem hero com todas as otimiza√ß√µes */}
{/* src/components/sections/Hero.astro */}
---
const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME
const heroImageBase = `https://res.cloudinary.com/${cloudName}/image/upload`

// Transforma√ß√µes Cloudinary: formato auto, qualidade auto, crop fit
const heroImage = {
  src: `${heroImageBase}/v1/stl-festival/hero-bg.jpg`,
  srcset: [
    `${heroImageBase}/w_320,f_auto,q_auto/v1/stl-festival/hero-bg.jpg 320w`,
    `${heroImageBase}/w_768,f_auto,q_auto/v1/stl-festival/hero-bg.jpg 768w`,
    `${heroImageBase}/w_1200,f_auto,q_auto/v1/stl-festival/hero-bg.jpg 1200w`,
  ].join(', '),
  width: 1200,
  height: 800,
}
---

{/* Hero: eager + high priority para LCP */}
<img
  src={heroImage.src}
  srcset={heroImage.srcset}
  sizes="(max-width: 768px) 100vw, 1200px"
  width={heroImage.width}
  height={heroImage.height}
  alt="STL Festival 2026 ‚Äî Vista do STL Valley"
  loading="eager"
  fetchpriority="high"
  decoding="async"
/>

{/* ‚úÖ CORRETO: Imagem below-the-fold com lazy loading */}
{/* src/components/sections/Lineup.astro */}
---
const artistImageBase = `https://res.cloudinary.com/${cloudName}/image/upload`
---

{artists.map(artist => (
  <img
    src={`${artistImageBase}/w_400,f_auto,q_auto/v1/stl-festival/artists/${artist.slug}.jpg`}
    srcset={`
      ${artistImageBase}/w_200,f_auto,q_auto/v1/stl-festival/artists/${artist.slug}.jpg 200w,
      ${artistImageBase}/w_400,f_auto,q_auto/v1/stl-festival/artists/${artist.slug}.jpg 400w
    `}
    sizes="(max-width: 640px) 100vw, 400px"
    width={400}
    height={400}
    alt={`${artist.name} ‚Äî ${artist.genre}`}
    loading="lazy"
    decoding="async"
  />
))}
```

```astro
{/* ‚úÖ CORRETO: Font loading otimizado */}
{/* src/layouts/Layout.astro */}
<head>
  {/* Preconnect para font CDN */}
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  {/* Preload das fontes critical */}
  <link
    rel="preload"
    href="https://fonts.googleapis.com/css2?family=Jairo&display=swap"
    as="style"
  />

  {/* Font display swap previne FOIT */}
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jairo&display=swap');

    :root {
      --font-heading: 'Jairo', serif;
      --font-body: system-ui, -apple-system, sans-serif; {/* system fonts para body */}
    }

    h1, h2, h3 { font-family: var(--font-heading); }
    body { font-family: var(--font-body); } {/* NUNCA custom font no body */}
  </style>

  {/* ‚úÖ Google Analytics com defer ‚Äî n√£o bloqueia render */}
  <script async src="https://www.google-analytics.com/gtag/js?id={PUBLIC_GA_ID}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{PUBLIC_GA_ID}');
  </script>
</head>
```

```typescript
// ‚úÖ CORRETO: Import espec√≠fico do Framer Motion (tree-shakeable)
// src/components/islands/FAQAccordion.tsx
import { motion, AnimatePresence } from 'framer-motion'
// Apenas os components usados ‚Äî n√£o import { * }

// ‚ùå ERRADO:
// import * as framerMotion from 'framer-motion'  // pega tudo no bundle
```

CHECKLIST PRE-PR:
- [ ] Lighthouse score ‚â• 90 no deploy preview
- [ ] Todas imagens com width + height expl√≠citos
- [ ] Imagens hero: loading="eager" fetchpriority="high"
- [ ] Imagens below-fold: loading="lazy"
- [ ] Todas imagens via Cloudinary com f_auto,q_auto
- [ ] Custom fonts apenas em headings, body usa system-ui
- [ ] Font loading com preconnect + preload + font-display: swap
- [ ] Scripts externos com async ou defer
- [ ] No import completo de libraries (tree-shaking verificado)
- [ ] CLS < 0.1 verificado via PageSpeed Insights
